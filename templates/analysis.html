<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥å…»åˆ†æ</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter','Microsoft YaHei',Arial,sans-serif;background:#F3F4F6;min-height:100vh;padding:80px 20px 20px}
        .navbar{position:fixed;top:0;left:0;width:100%;background:rgba(255,255,255,0.95);padding:15px 30px;border-radius:0 0 15px 15px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 5px 15px rgba(0,0,0,0.1);z-index:1000;backdrop-filter:blur(10px)}
        .navbar a{color:#34D399;text-decoration:none;margin:0 15px;font-weight:700}
        .container{max-width:1200px;margin:0 auto;background:#FFFFFF;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.15);padding:24px}
        .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:700;color:#FFFFFF;background:#34D399;cursor:pointer;transition:transform .2s ease}
        .btn:hover{transform:scale(1.03);box-shadow:0 8px 20px rgba(52,211,153,.35)}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .card{background:#FFFFFF;border:2px solid #E5E7EB;border-radius:12px;padding:16px}
        .donut{width:220px;height:220px;border-radius:50%;background:conic-gradient(#34D399 var(--p), #E5E7EB 0);display:flex;align-items:center;justify-content:center;margin:10px auto}
        .donut-inner{width:150px;height:150px;border-radius:50%;background:#FFFFFF;display:flex;align-items:center;justify-content:center;flex-direction:column}
        .table{margin-top:12px}
        .row{display:grid;grid-template-columns:1.5fr 1fr 1fr 1fr;gap:8px;padding:8px;border-bottom:1px solid #E5E7EB}
        .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;color:#FFFFFF;background:#F97316}
    </style>
</head>
<body>
    <div class="navbar">
        <div>
            <a href="/">ğŸ  é¦–é¡µ</a>
            <a href="/library">ğŸ“š èœå“åº“</a>
            <a href="/recommend">ğŸ’¡ ä¸ªæ€§åŒ–æ¨è</a>
            <a href="/pickup">âš–ï¸ å–é¤è¯†åˆ«</a>
        </div>
        <div>
            <a href="/">â¬…ï¸ è¿”å›</a>
            <button class="btn" onclick="share()">åˆ†äº«æŠ¥å‘Š</button>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div class="card">
                <h3 style="margin-bottom:8px;color:#111;font-weight:800">è¥å…»å æ¯”</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;text-align:center">
                    <div>
                        <div class="donut" style="--p:0deg"><div class="donut-inner"><div id="energy_v" style="font-weight:800">0%</div><div style="font-size:12px;color:#6B7280">èƒ½é‡</div></div></div>
                    </div>
                    <div>
                        <div class="donut" style="--p:0deg"><div class="donut-inner"><div id="protein_v" style="font-weight:800">0%</div><div style="font-size:12px;color:#6B7280">è›‹ç™½è´¨</div></div></div>
                    </div>
                    <div>
                        <div class="donut" style="--p:0deg"><div class="donut-inner"><div id="fat_v" style="font-weight:800">0%</div><div style="font-size:12px;color:#6B7280">è„‚è‚ª</div></div></div>
                    </div>
                    <div>
                        <div class="donut" style="--p:0deg"><div class="donut-inner"><div id="carb_v" style="font-weight:800">0%</div><div style="font-size:12px;color:#6B7280">ç¢³æ°´</div></div></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:8px;color:#111;font-weight:800">è¥å…»ç¼ºå£</h3>
                <div id="gap" style="border:2px solid #FCA5A5;border-radius:10px;padding:10px;color:#B91C1C">æš‚æ— æ•°æ®</div>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h3 style="margin-bottom:8px;color:#111;font-weight:800">èœå“æ˜ç»†</h3>
            <div class="table" id="table"></div>
            <div style="margin-top:12px">
                <a class="btn" style="display:inline-block;text-decoration:none" href="/recommend">æŸ¥çœ‹ä¸ªæ€§åŒ–è¡¥èƒ½èœå“ âœ</a>
            </div>
        </div>
    </div>

    <script>
        function share(){ alert('æŠ¥å‘Šå·²åˆ†äº«'); }
        function setDonut(el, percent){
            const deg = Math.min(100, Math.max(0, percent)) * 3.6;
            el.parentElement.parentElement.style.setProperty('--p', deg+'deg');
            el.textContent = Math.round(percent)+'%';
        }
        const dataStr = sessionStorage.getItem('last_detection');
        if(!dataStr){ document.getElementById('gap').textContent='è¯·å…ˆåœ¨å–é¤è¯†åˆ«é¡µå®Œæˆä¸€æ¬¡è¯†åˆ«'; }
        try{
            const data = JSON.parse(dataStr || '{}');
            const nutrition = (data.alignment && data.alignment.nutrition) || [];
            let cal=0, pro=0, fat=0, carb=0;
            nutrition.forEach(n=>{
                (n.nutrients||[]).forEach(m=>{
                    const v = parseFloat(m.value||'0');
                    if(m.name==='çƒ­é‡') cal += v; else if(m.name==='è›‹ç™½è´¨') pro += v; else if(m.name==='è„‚è‚ª') fat += v; else if(m.name==='ç¢³æ°´åŒ–åˆç‰©') carb += v;
                });
            });
            const recCal=2000, recPro=75, recFat=67, recCarb=275;
            setDonut(document.getElementById('energy_v'), cal/recCal*100);
            setDonut(document.getElementById('protein_v'), pro/recPro*100);
            setDonut(document.getElementById('fat_v'), fat/recFat*100);
            setDonut(document.getElementById('carb_v'), carb/recCarb*100);
            const gaps=[];
            if(pro<recPro) gaps.push(`ä»Šæ—¥è›‹ç™½è´¨æ‘„å…¥ä¸è¶³ï¼Œè¿˜éœ€ ${(recPro-pro).toFixed(1)}g`);
            if(cal<recCal) gaps.push(`èƒ½é‡ä¸è¶³ï¼Œå»ºè®®æå‡ ${(recCal-cal).toFixed(0)} kcal`);
            document.getElementById('gap').textContent = gaps.length? gaps.join('ï¼›') : 'æ‘„å…¥å……è¶³ï¼Œç»§ç»­ä¿æŒ';
            const table = document.getElementById('table');
            nutrition.forEach(item=>{
                const row = document.createElement('div');
                row.className='row';
                const kc = getVal(item.nutrients,'çƒ­é‡');
                const pr = getVal(item.nutrients,'è›‹ç™½è´¨');
                const fa = getVal(item.nutrients,'è„‚è‚ª');
                const ca = getVal(item.nutrients,'ç¢³æ°´åŒ–åˆç‰©');
                row.innerHTML = `<div><strong>${item.dish_name}</strong> <span class="badge">${highlight(item.nutrients)}</span></div>
                                 <div>${kc}</div><div>${pr}g</div><div>${fa}g / ${ca}g</div>`;
                table.appendChild(row);
            });
            function getVal(arr, name){ const f = (arr||[]).find(x=>x.name===name); return f? parseFloat(f.value||'0').toFixed(1):'0.0'; }
            function highlight(arr){ const pr = parseFloat(getVal(arr,'è›‹ç™½è´¨')); return pr>20? 'é«˜è›‹ç™½':'ä½ç³–'; }
        }catch(e){ console.warn(e); }
    </script>
</body>
</html>
