<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOç›®æ ‡æ£€æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 80px 20px 20px 20px;
            /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }

        /* å›ºå®šå¯¼èˆªæ æ ·å¼ */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        /* å“åº”å¼è®¾è®¡ - åª’ä½“æŸ¥è¯¢ */
        @media (max-width: 768px) {
            /* è°ƒæ•´æ•´ä½“å†…è¾¹è· */
            body {
                padding: 120px 15px 15px 15px;
            }

            /* å¯¼èˆªæ è°ƒæ•´ */
            .navbar {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }

            /* å®¹å™¨è°ƒæ•´ */
            .container {
                padding: 25px;
                border-radius: 15px;
            }

            /* æ ‡é¢˜å¤§å°è°ƒæ•´ */
            h1 {
                font-size: 1.8em !important;
                margin-bottom: 20px !important;
            }

            /* æŒ‰é’®ç»„è°ƒæ•´ */
            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            button {
                padding: 12px 25px;
                font-size: 14px;
                width: 100%;
                max-width: 250px;
            }

            .btn-success {
                padding: 15px 30px;
                font-size: 16px;
            }

            /* BMRè®¡ç®—å™¨è¡¨å•è°ƒæ•´ */
            .bmr-form-row {
                flex-direction: column;
                gap: 10px;
            }

            /* ç½‘æ ¼å¸ƒå±€è°ƒæ•´ */
            .results-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .macro-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .macro-item {
                padding: 10px;
            }

            .macro-value {
                font-size: 20px;
            }

            /* æ¨¡æ€æ¡†è°ƒæ•´ */
            .modal-content {
                padding: 20px;
                width: 95%;
                border-radius: 15px;
            }

            /* ä¸Šä¼ æç¤ºä¿¡æ¯è°ƒæ•´ */
            div[style*="margin-top: 15px; padding: 12px; background: #e3f2fd;"] {
                padding: 10px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            /* è¿›ä¸€æ­¥ç¼©å°å±å¹•çš„è°ƒæ•´ */
            body {
                padding: 100px 10px 10px 10px;
            }

            .container {
                padding: 20px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.5em !important;
            }

            button {
                padding: 10px 20px;
                font-size: 13px;
                max-width: 220px;
            }

            .macro-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .modal-content {
                padding: 15px;
            }

            /* è¥å…»ä¿¡æ¯å¡ç‰‡è°ƒæ•´ */
            div[style*="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));"] {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-size: 18px;
            padding: 18px 40px;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-success:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input[type="file"] {
            display: none;
        }

        .image-preview {
            margin: 30px 0;
            text-align: center;
        }

        .preview-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        .preview-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .results h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .detection-item {
            background: white;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detection-item strong {
            color: #667eea;
        }

        .error {
            color: #f5576c;
            text-align: center;
            padding: 15px;
            background: #ffe6e6;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        /* BMRè®¡ç®—å™¨æ ·å¼ */
        #bmrCalculator {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #bmrCalculator h3 {
            color: #9c27b0;
            margin-bottom: 15px;
        }

        .bmr-form-group {
            margin-bottom: 15px;
        }

        .bmr-form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .bmr-form-row .bmr-form-group {
            flex: 1;
        }

        .bmr-result {
            margin-top: 20px;
            padding: 15px;
            background: #e6f7ff;
            border-radius: 8px;
            border-left: 4px solid #1890ff;
        }

        .bmr-result h4 {
            color: #1890ff;
            margin-bottom: 10px;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .macro-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .macro-item.protein {
            color: #ff9800;
        }

        .macro-item.fat {
            color: #e91e63;
        }

        .macro-item.carbs {
            color: #9c27b0;
        }

        .macro-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }

        .macro-unit {
            font-size: 12px;
            color: #666;
        }

        #cameraModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div>
            <a href="/" style="color: #667eea; text-decoration: none; margin: 0 15px; font-weight: bold;">ğŸ  é¦–é¡µ</a>
            <a href="/profile" style="color: #667eea; text-decoration: none; margin: 0 15px; font-weight: bold;">ğŸ‘¤
                ä¸ªäººèµ„æ–™</a>
            <a href="/history" style="color: #667eea; text-decoration: none; margin: 0 15px; font-weight: bold;">ğŸ“Š
                æ£€æµ‹å†å²</a>
            {% if user and user.is_admin %}
            <a href="/admin" style="color: #f5576c; text-decoration: none; margin: 0 15px; font-weight: bold;">ğŸ› ï¸
                ç®¡ç†åå°</a>
            {% endif %}
        </div>
        <div>
            <span style="color: #666;">æ¬¢è¿, {% if user %}{{ user.username }}{% endif %}</span>
            <a href="/logout" style="color: #667eea; text-decoration: none; margin: 0 15px; font-weight: bold;">ğŸšª
                é€€å‡º</a>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ¯ YOLOç›®æ ‡æ£€æµ‹</h1>

        <div class="upload-section">
            <div class="button-group">
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                    ğŸ“ é€‰æ‹©å›¾ç‰‡
                </button>
                <button class="btn-secondary" onclick="openCamera()">
                    ğŸ“· æ‹ç…§ä¸Šä¼ 
                </button>
                <button class="btn-warning" onclick="toggleWeightInput()" id="weightToggleBtn"
                    style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                    âš–ï¸ æ·»åŠ é‡é‡æ•°æ®
                </button>
                <button class="btn-info" onclick="toggleBMRCalculator()" id="bmrToggleBtn"
                    style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                    ğŸ§® BMRè®¡ç®—å™¨
                </button>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
            <div
                style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 5px;">
                <strong style="color: #1976d2;">ğŸ’¡ æç¤ºï¼š</strong>
                <span style="color: #555;">
                    ç‚¹å‡»â€œâš–ï¸ æ·»åŠ é‡é‡æ•°æ®â€æŒ‰é’®ï¼Œè¾“å…¥æˆ–æ¨¡æ‹Ÿé‡é‡åºåˆ—ï¼Œå³å¯å¯ç”¨<strong>è§†è§‰-é‡é‡å¯¹é½åŠŸèƒ½</strong>ï¼Œ
                    ä¸ºæ¯ä¸ªæ£€æµ‹åˆ°çš„èœå“è‡ªåŠ¨åˆ†é…ç²¾å‡†é‡é‡ã€‚
                </span>
            </div>
        </div>

        <!-- BMRè®¡ç®—å™¨ -->
        <div id="bmrCalculator">
            <h3>ğŸ§® åŸºç¡€ä»£è°¢ç‡(BMR) & æ€»èƒ½é‡æ¶ˆè€—(TDEE) è®¡ç®—å™¨</h3>
            <div class="bmr-form-row">
                <div class="bmr-form-group">
                    <label>ä½“é‡ (kg)</label>
                    <input type="number" id="bmrWeight" step="0.1" placeholder="ä¾‹å¦‚: 70.5">
                </div>
                <div class="bmr-form-group">
                    <label>èº«é«˜ (cm)</label>
                    <input type="number" id="bmrHeight" step="0.1" placeholder="ä¾‹å¦‚: 175">
                </div>
            </div>
            <div class="bmr-form-row">
                <div class="bmr-form-group">
                    <label>å¹´é¾„</label>
                    <input type="number" id="bmrAge" placeholder="ä¾‹å¦‚: 25">
                </div>
                <div class="bmr-form-group">
                    <label>æ€§åˆ«</label>
                    <select id="bmrGender">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
            </div>
            <div class="bmr-form-group">
                <label>æ´»åŠ¨æ°´å¹³</label>
                <select id="bmrActivity">
                    <option value="sedentary">ä¹…å (åŠå…¬å®¤å·¥ä½œï¼Œå¾ˆå°‘è¿åŠ¨)</option>
                    <option value="light">è½»åº¦ (æ¯å‘¨è½»åº¦è¿åŠ¨1-3å¤©)</option>
                    <option value="moderate" selected>ä¸­åº¦ (æ¯å‘¨ä¸­åº¦è¿åŠ¨3-5å¤©)</option>
                    <option value="heavy">é‡åº¦ (æ¯å‘¨é«˜å¼ºåº¦è¿åŠ¨6-7å¤©)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="calculateBMR()" style="width: 100%;">ğŸ“Š è®¡ç®— BMR & TDEE</button>
            <div id="bmrResult" class="bmr-result" style="display: none;"></div>
        </div>

        <!-- é‡é‡æ•°æ®è¾“å…¥åŒºåŸŸ -->
        <div id="weightInputSection"
            style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">âš–ï¸ é‡é‡ä¼ æ„Ÿå™¨æ•°æ®</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn-primary" onclick="simulateWeightData()" style="padding: 10px 20px;">
                    ğŸ§ª æ¨¡æ‹Ÿé‡é‡æ•°æ®
                </button>
                <button class="btn-secondary" onclick="clearWeightData()" style="padding: 10px 20px; background: #999;">
                    ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
                </button>
                <span style="margin-left: 15px; color: #666;">æˆ–è€…æ‰‹åŠ¨è¾“å…¥é‡é‡åºåˆ—ï¼ˆæ¯è¡Œä¸€ä¸ªé‡é‡ï¼Œå•ä½ï¼šå…‹ï¼‰</span>
            </div>
            <textarea id="weightDataInput" placeholder="ç¤ºä¾‹ï¼š&#10;85.5&#10;45.2&#10;120.3&#10;55.1&#10;&#10;æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è‡ªåŠ¨æ¨¡æ‹Ÿ"
                style="width: 100%; height: 120px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 14px;"></textarea>
            <div id="weightDataStatus" style="margin-top: 10px; color: #4caf50; display: none;">
                âœ… å·²åŠ è½½ <span id="weightEventCount">0</span> æ¡é‡é‡äº‹ä»¶
            </div>
        </div>

        <div class="image-preview" id="imagePreview"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æ£€æµ‹ä¸­...</p>
        </div>

        <div class="error" id="error"></div>

        <div style="text-align: center;">
            <button class="btn-success" id="detectBtn" onclick="detectObjects()" disabled>
                ğŸš€ å¼€å§‹æ£€æµ‹
            </button>
        </div>

        <div class="results" id="results">
            <div class="results-grid">
                <div class="result-card">
                    <h3>ğŸ” æ£€æµ‹ç»“æœ</h3>
                    <div id="detectionResults"></div>
                </div>
                <div class="result-card">
                    <h3>ğŸ“Š è¥å…»åˆ†æ</h3>
                    <div id="nutritionSummary"></div>
                </div>
            </div>
        </div>

        <!-- é‡é‡å¯¹é½ç»“æœ -->
        <div id="alignmentResults"
            style="display: none; margin-top: 30px; padding: 25px; background: #f0f7ff; border-radius: 10px; border-left: 4px solid #667eea;">
            <h2 style="color: #667eea; margin-bottom: 20px;">âš–ï¸ è§†è§‰-é‡é‡å¯¹é½ç»“æœ</h2>

            <div id="alignmentMetrics"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
            </div>

            <div id="alignmentDetails"></div>
        </div>
    </div>

    <!-- ç›¸æœºæ¨¡æ€æ¡† -->
    <div id="cameraModal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“· æ‹ç…§</h2>
            <video id="video" autoplay></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <div class="modal-buttons">
                <button class="btn-success" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
                <button class="btn-primary" onclick="closeCamera()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let currentImage = null;
        let stream = null;
        let weightDataEnabled = false;
        let currentWeightData = null;
        let bmrCalculatorEnabled = false;

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨å¡«å……ç”¨æˆ·ä¿¡æ¯
        window.addEventListener('DOMContentLoaded', function () {
            // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œå°è¯•å¡«å……ä¸ªäººä¿¡æ¯
            fetch('/profile')
                .then(response => response.json())
                .then(user => {
                    if (user && user.height && user.weight && user.age && user.gender) {
                        document.getElementById('bmrHeight').value = user.height;
                        document.getElementById('bmrWeight').value = user.weight;
                        document.getElementById('bmrAge').value = user.age;
                        document.getElementById('bmrGender').value = user.gender;
                    }
                })
                .catch(err => {
                    console.log('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯:', err);
                });
        });

        function toggleBMRCalculator() {
            bmrCalculatorEnabled = !bmrCalculatorEnabled;
            const section = document.getElementById('bmrCalculator');
            const btn = document.getElementById('bmrToggleBtn');
            const result = document.getElementById('bmrResult');

            if (bmrCalculatorEnabled) {
                section.style.display = 'block';
                btn.textContent = 'ğŸ§® éšè—BMRè®¡ç®—å™¨';
                btn.style.background = 'linear-gradient(135deg, #673ab7 0%, #9c27b0 100%)';
            } else {
                section.style.display = 'none';
                btn.textContent = 'ğŸ§® BMRè®¡ç®—å™¨';
                btn.style.background = 'linear-gradient(135deg, #9c27b0 0%, #673ab7 100%)';
                // æ¸…é™¤ç»“æœ
                result.style.display = 'none';
                result.innerHTML = '';
            }
        }

        function toggleWeightInput() {
            weightDataEnabled = !weightDataEnabled;
            const section = document.getElementById('weightInputSection');
            const btn = document.getElementById('weightToggleBtn');

            if (weightDataEnabled) {
                section.style.display = 'block';
                btn.textContent = 'âš–ï¸ éšè—é‡é‡æ•°æ®';
                btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
            } else {
                section.style.display = 'none';
                btn.textContent = 'âš–ï¸ æ·»åŠ é‡é‡æ•°æ®';
                btn.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
            }
        }

        function simulateWeightData() {
            // æ ¹æ®å½“å‰å›¾ç‰‡ä¼°è®¡èœå“æ•°é‡ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
            const numFoods = 3 + Math.floor(Math.random() * 3); // 3-5ä¸ªèœå“
            const weights = [];

            for (let i = 0; i < numFoods; i++) {
                // ç”Ÿæˆ 30-150g çš„éšæœºé‡é‡
                const weight = (30 + Math.random() * 120).toFixed(1);
                weights.push(weight);
            }

            document.getElementById('weightDataInput').value = weights.join('\n');
            updateWeightDataStatus(weights.length);
        }

        function calculateBMR() {
            const weight = parseFloat(document.getElementById('bmrWeight').value);
            const height = parseFloat(document.getElementById('bmrHeight').value);
            const age = parseInt(document.getElementById('bmrAge').value);
            const gender = document.getElementById('bmrGender').value;
            const activityLevel = document.getElementById('bmrActivity').value;

            if (!weight || !height || !age || !gender) {
                alert('è¯·å¡«å†™å®Œæ•´çš„èº«ä½“ä¿¡æ¯');
                return;
            }

            // å‘é€åˆ°åç«¯è®¡ç®—
            fetch('/calculate_bmr_tdee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    weight: weight,
                    height: height,
                    age: age,
                    gender: gender,
                    activity_level: activityLevel
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayBMRResult(data.data);
                    } else {
                        alert('è®¡ç®—å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('è®¡ç®—å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•');
                });
        }

        function displayBMRResult(result) {
            const resultDiv = document.getElementById('bmrResult');
            const activityLabels = {
                'sedentary': 'ä¹…åç”Ÿæ´»æ–¹å¼',
                'light': 'è½»åº¦æ´»åŠ¨',
                'moderate': 'ä¸­åº¦æ´»åŠ¨',
                'heavy': 'é‡åº¦æ´»åŠ¨'
            };

            const macro = result.macronutrients;
            resultDiv.innerHTML = `
                <h4>è®¡ç®—ç»“æœ</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: #fffbe6; padding: 10px; border-radius: 5px;">
                        <strong>åŸºç¡€ä»£è°¢ç‡ (BMR)</strong><br>
                        <span style="font-size: 18px; color: #1890ff;">${result.bmr} åƒå¡/å¤©</span>
                    </div>
                    <div style="background: #f0f8ff; padding: 10px; border-radius: 5px;">
                        <strong>æ€»èƒ½é‡æ¶ˆè€— (TDEE)</strong><br>
                        <span style="font-size: 18px; color: #52c41a;">${result.tdee} åƒå¡/å¤©</span><br>
                        <small>${activityLabels[result.activity_multiplier] || 'æœªçŸ¥æ´»åŠ¨æ°´å¹³'}</small>
                    </div>
                </div>
                
                <h4>å®é‡è¥å…»ç´ æ¨èæ‘„å…¥é‡</h4>
                <div class="macro-grid">
                    <div class="macro-item protein">
                        <div>è›‹ç™½è´¨</div>
                        <div class="macro-value">${macro.protein.grams}</div>
                        <div class="macro-unit">å…‹/å¤©</div>
                        <div>${macro.protein.calories} åƒå¡ (${macro.protein.percentage}%)</div>
                    </div>
                    <div class="macro-item fat">
                        <div>è„‚è‚ª</div>
                        <div class="macro-value">${macro.fat.grams}</div>
                        <div class="macro-unit">å…‹/å¤©</div>
                        <div>${macro.fat.calories} åƒå¡ (${macro.fat.percentage}%)</div>
                    </div>
                    <div class="macro-item carbs">
                        <div>ç¢³æ°´åŒ–åˆç‰©</div>
                        <div class="macro-value">${macro.carbohydrates.grams}</div>
                        <div class="macro-unit">å…‹/å¤©</div>
                        <div>${macro.carbohydrates.calories} åƒå¡ (${macro.carbohydrates.percentage}%)</div>
                    </div>
                </div>
            `;

            resultDiv.style.display = 'block';

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }

        function updateWeightDataStatus(count) {
            document.getElementById('weightEventCount').textContent = count;
            document.getElementById('weightDataStatus').style.display = 'block';
        }

        function parseWeightData() {
            const input = document.getElementById('weightDataInput').value.trim();
            if (!input) return null;

            const weights = input.split('\n')
                .map(line => parseFloat(line.trim()))
                .filter(w => !isNaN(w) && w > 0);

            if (weights.length === 0) return null;

            // æ„å»ºé‡é‡äº‹ä»¶åºåˆ—
            const events = [{
                timestamp: 0,
                cumulative_weight: 0,
                delta_weight: 0
            }];

            let cumulative = 0;
            let timestamp = 0;

            weights.forEach(weight => {
                timestamp += 1.0 + Math.random() * 0.5; // æ¨¡æ‹Ÿæ—¶é—´é—´éš”
                cumulative += weight;
                events.push({
                    timestamp: timestamp,
                    cumulative_weight: cumulative,
                    delta_weight: weight
                });
            });

            updateWeightDataStatus(weights.length);
            return events;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentImage = file;
                displayImage(file);
                document.getElementById('detectBtn').disabled = false;
                clearResults();
            }
        }

        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `
                    <div class="preview-container">
                        <img src="${e.target.result}" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        async function openCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                document.getElementById('cameraModal').style.display = 'flex';
            } catch (err) {
                showError('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + err.message);
            }
        }

        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('cameraModal').style.display = 'none';
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(function (blob) {
                currentImage = new File([blob], "camera-photo.jpg", { type: "image/jpeg" });
                displayImage(currentImage);
                document.getElementById('detectBtn').disabled = false;
                clearResults();
                closeCamera();
            }, 'image/jpeg');
        }

        async function detectObjects() {
            if (!currentImage) {
                showError('è¯·å…ˆé€‰æ‹©æˆ–æ‹æ‘„å›¾ç‰‡');
                return;
            }

            const formData = new FormData();
            formData.append('image', currentImage);

            // å¦‚æœå¯ç”¨äº†é‡é‡æ•°æ®ï¼Œè§£æå¹¶æ·»åŠ åˆ°è¯·æ±‚ä¸­
            if (weightDataEnabled) {
                const weightData = parseWeightData();
                if (weightData) {
                    formData.append('weight_data', JSON.stringify(weightData));
                    currentWeightData = weightData;
                } else if (document.getElementById('weightDataInput').value.trim()) {
                    showError('é‡é‡æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                    return;
                }
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('alignmentResults').style.display = 'none';
            document.getElementById('detectBtn').disabled = true;

            try {
                const response = await fetch('/detect', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                console.log('æ£€æµ‹å“åº”æ•°æ®:', data); // è°ƒè¯•æ—¥å¿—

                if (data.success) {
                    displayResults(data);

                    // å¦‚æœæœ‰å¯¹é½ç»“æœï¼Œæ˜¾ç¤º
                    if (data.alignment && !data.alignment.error) {
                        console.log('å¯¹é½ç»“æœ:', data.alignment); // è°ƒè¯•æ—¥å¿—
                        displayAlignmentResults(data.alignment);
                    } else if (data.alignment && data.alignment.error) {
                        console.error('å¯¹é½é”™è¯¯:', data.alignment.error);
                        showError('å¯¹é½å¤±è´¥: ' + data.alignment.error);
                    } else if (weightDataEnabled && document.getElementById('weightDataInput').value.trim()) {
                        console.warn('æœ‰é‡é‡æ•°æ®ä½†æ²¡æœ‰è¿”å›å¯¹é½ç»“æœ');
                        showError('æœªèƒ½å®Œæˆé‡é‡å¯¹é½ï¼Œè¯·æ£€æŸ¥é‡é‡æ•°æ®æ ¼å¼');
                    }
                } else {
                    showError(data.error || 'æ£€æµ‹å¤±è´¥');
                }
            } catch (err) {
                showError('ç½‘ç»œé”™è¯¯: ' + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('detectBtn').disabled = false;
            }
        }

        function displayResults(data) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `
                <div class="preview-container">
                    <img src="${data.image}" class="preview-image" alt="æ£€æµ‹ç»“æœ">
                </div>
            `;

            // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
            const detectionResultsDiv = document.getElementById('detectionResults');
            let detectionHTML = `<h4>å…±æ£€æµ‹åˆ° ${data.count} ä¸ªç›®æ ‡</h4>`;

            if (data.detections.length > 0) {
                data.detections.forEach((det, index) => {
                    detectionHTML += `
                        <div class="detection-item">
                            <strong>ç›®æ ‡ ${index + 1}:</strong> 
                            ${det.class} 
                            (ç½®ä¿¡åº¦: ${(det.confidence * 100).toFixed(2)}%)
                        </div>
                    `;
                });
            } else {
                detectionHTML += '<p>æœªæ£€æµ‹åˆ°ä»»ä½•ç›®æ ‡</p>';
            }

            detectionResultsDiv.innerHTML = detectionHTML;

            // æ˜¾ç¤ºè¥å…»æ‘˜è¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const nutritionSummaryDiv = document.getElementById('nutritionSummary');
            nutritionSummaryDiv.innerHTML = `
                <p>è¯·æ·»åŠ é‡é‡æ•°æ®ä»¥è·å–è¯¦ç»†çš„è¥å…»åˆ†æ</p>
                <button class="btn-primary" onclick="toggleWeightInput(); document.getElementById('weightToggleBtn').scrollIntoView({behavior: 'smooth'});" style="margin-top: 10px;">
                    âš–ï¸ æ·»åŠ é‡é‡æ•°æ®
                </button>
            `;

            document.getElementById('results').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('alignmentResults').style.display = 'none';
        }

        function displayAlignmentResults(alignment) {
            const resultsDiv = document.getElementById('alignmentResults');
            const metricsDiv = document.getElementById('alignmentMetrics');
            const detailsDiv = document.getElementById('alignmentDetails');

            // æ˜¾ç¤ºæŒ‡æ ‡
            const metrics = alignment.metrics;
            metricsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">æ€»èœå“æ•°</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${metrics.total_foods}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">æˆåŠŸåŒ¹é…</div>
                    <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${metrics.matched_foods}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">æœªåŒ¹é…</div>
                    <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${metrics.unmatched_foods}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">å¹³å‡ç½®ä¿¡åº¦</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${(metrics.avg_confidence * 100).toFixed(1)}%</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">æ€»é‡é‡</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${metrics.total_weight.toFixed(1)}g</div>
                </div>
            `;

            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            let detailsHTML = '';
            alignment.aligned_foods.forEach((food, i) => {
                const matchedClass = food.matched ? 'matched' : 'unmatched';
                const matchedIcon = food.matched ? 'âœ…' : 'âš ï¸';
                const matchedText = food.matched ? 'å·²åŒ¹é…' : 'æœªåŒ¹é…ï¼ˆä½¿ç”¨ä¼°è®¡å€¼ï¼‰';
                const borderColor = food.matched ? '#4caf50' : '#ff9800';

                detailsHTML += `
                    <div style="background: white; padding: 20px; margin: 10px 0; border-radius: 10px; border-left: 4px solid ${borderColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #333; margin: 0;">èœå“ #${i + 1}: ${food.class}</h3>
                            <span style="padding: 5px 12px; background: ${food.matched ? '#e8f5e9' : '#fff3e0'}; color: ${food.matched ? '#4caf50' : '#ff9800'}; border-radius: 20px; font-size: 14px; font-weight: bold;">
                                ${matchedIcon} ${matchedText}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #999; font-size: 13px; margin-bottom: 5px;">é‡é‡</div>
                                <div style="font-size: 20px; font-weight: bold; color: #667eea;">${food.weight.toFixed(2)} å…‹</div>
                            </div>
                            <div>
                                <div style="color: #999; font-size: 13px; margin-bottom: 5px;">å¯¹é½ç½®ä¿¡åº¦</div>
                                <div style="font-size: 20px; font-weight: bold; color: ${food.confidence > 0.7 ? '#4caf50' : food.confidence > 0.4 ? '#ff9800' : '#f5576c'};">
                                    ${(food.confidence * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div>
                                <div style="color: #999; font-size: 13px; margin-bottom: 5px;">ä½ç½®ä¿¡æ¯</div>
                                <div style="font-size: 14px; color: #666;">
                                    (${food.bbox[0].toFixed(0)}, ${food.bbox[1].toFixed(0)}) - (${food.bbox[2].toFixed(0)}, ${food.bbox[3].toFixed(0)})
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            detailsDiv.innerHTML = detailsHTML;
            resultsDiv.style.display = 'block';

            // æ˜¾ç¤ºè¥å…»ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (alignment.nutrition && alignment.nutrition.length > 0) {
                displayNutritionInfo(alignment.nutrition);
            }

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            setTimeout(() => {
                // å…ˆæ»šåŠ¨åˆ°æ£€æµ‹ç»“æœ
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // ç„¶åæ»šåŠ¨åˆ°å¯¹é½ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
                if (resultsDiv.style.display !== 'none') {
                    setTimeout(() => {
                        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 500);
                }
            }, 300);
        }

        function displayNutritionInfo(nutritionData) {
            let nutritionHTML = '<div style="margin-top: 30px; padding: 25px; background: #f0fff4; border-radius: 10px; border-left: 4px solid #4caf50;">';
            nutritionHTML += '<h2 style="color: #4caf50; margin-bottom: 20px;">ğŸ¥— è¥å…»æˆåˆ†è¯¦æƒ…</h2>';

            let totalCalories = 0;
            let totalProtein = 0;
            let totalFat = 0;
            let totalCarbs = 0;

            nutritionData.forEach((item, index) => {
                if (item.error) {
                    // æ²¡æœ‰è¥å…»æ•°æ®
                    nutritionHTML += `
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #999;">
                            <h3 style="color: #666; margin-bottom: 10px;">${item.dish_name} (${item.weight})</h3>
                            <p style="color: #999; margin: 0;">âš ï¸ ${item.error}</p>
                        </div>
                    `;
                } else {
                    // æœ‰è¥å…»æ•°æ®
                    // è®¡ç®—æ€»è¥å…»
                    item.nutrients.forEach(nutrient => {
                        if (nutrient.name === 'çƒ­é‡') totalCalories += parseFloat(nutrient.value);
                        else if (nutrient.name === 'è›‹ç™½è´¨') totalProtein += parseFloat(nutrient.value);
                        else if (nutrient.name === 'è„‚è‚ª') totalFat += parseFloat(nutrient.value);
                        else if (nutrient.name === 'ç¢³æ°´åŒ–åˆç‰©') totalCarbs += parseFloat(nutrient.value);
                    });

                    nutritionHTML += `
                        <div style="background: white; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
                                <h3 style="color: #333; margin: 0 0 5px 0;">${item.dish_name}</h3>
                                <div style="color: #666; font-size: 14px;">
                                    <span>ğŸª ${item.canteen}</span>
                                    <span style="margin-left: 15px;">ğŸ³ ${item.cooking_method}</span>
                                    <span style="margin-left: 15px; font-weight: bold; color: #667eea;">âš–ï¸ ${item.weight}</span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                    `;

                    item.nutrients.forEach(nutrient => {
                        const value = parseFloat(nutrient.value);
                        let color = '#667eea';

                        // æ ¹æ®è¥å…»æˆåˆ†è®¾ç½®ä¸åŒé¢œè‰²
                        if (nutrient.name === 'çƒ­é‡') color = '#f5576c';
                        else if (nutrient.name === 'è›‹ç™½è´¨') color = '#ff9800';
                        else if (nutrient.name === 'è„‚è‚ª') color = '#e91e63';
                        else if (nutrient.name === 'ç¢³æ°´åŒ–åˆç‰©') color = '#9c27b0';
                        else if (nutrient.name === 'è†³é£Ÿçº¤ç»´') color = '#4caf50';

                        nutritionHTML += `
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="color: #999; font-size: 12px; margin-bottom: 5px;">${nutrient.name}</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${color};">
                                    ${nutrient.value}
                                    <span style="font-size: 12px; font-weight: normal; color: #666;">${nutrient.unit}</span>
                                </div>
                            </div>
                        `;
                    });

                    nutritionHTML += `
                            </div>
                        </div>
                    `;
                }
            });

            // æ˜¾ç¤ºè¥å…»æ‘˜è¦
            const nutritionSummaryDiv = document.getElementById('nutritionSummary');
            nutritionSummaryDiv.innerHTML = `
                <h4>ğŸ½ï¸ æœ¬é¤è¥å…»æ€»è§ˆ</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: #fff5f5; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #f5576c; font-size: 12px; margin-bottom: 5px;">æ€»çƒ­é‡</div>
                        <div style="font-size: 24px; font-weight: bold; color: #f5576c;">${totalCalories.toFixed(1)}</div>
                        <div style="font-size: 12px; color: #666;">åƒå¡</div>
                    </div>
                    <div style="background: #fff8f0; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #ff9800; font-size: 12px; margin-bottom: 5px;">è›‹ç™½è´¨</div>
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${totalProtein.toFixed(1)}</div>
                        <div style="font-size: 12px; color: #666;">å…‹</div>
                    </div>
                    <div style="background: #fef5f7; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #e91e63; font-size: 12px; margin-bottom: 5px;">è„‚è‚ª</div>
                        <div style="font-size: 24px; font-weight: bold; color: #e91e63;">${totalFat.toFixed(1)}</div>
                        <div style="font-size: 12px; color: #666;">å…‹</div>
                    </div>
                    <div style="background: #f9f5ff; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="color: #9c27b0; font-size: 12px; margin-bottom: 5px;">ç¢³æ°´åŒ–åˆç‰©</div>
                        <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">${totalCarbs.toFixed(1)}</div>
                        <div style="font-size: 12px; color: #666;">å…‹</div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn-info" onclick="toggleBMRCalculator(); document.getElementById('bmrToggleBtn').scrollIntoView({behavior: 'smooth'});" style="padding: 8px 15px; font-size: 14px;">
                        ğŸ§® è®¡ç®—æˆ‘çš„BMR & TDEE
                    </button>
                </div>
            `;

            nutritionHTML += '</div>';

            // æ’å…¥åˆ°å¯¹é½ç»“æœåé¢
            const alignmentDiv = document.getElementById('alignmentResults');
            if (alignmentDiv) {
                alignmentDiv.insertAdjacentHTML('beforeend', nutritionHTML);
            }
        }
    </script>
</body>

</html>