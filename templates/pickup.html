<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–é¤è¯†åˆ«</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter','Microsoft YaHei',Arial,sans-serif;background:#F3F4F6;min-height:100vh;padding:80px 20px 20px}
        .navbar{position:fixed;top:0;left:0;width:100%;background:rgba(255,255,255,0.95);padding:15px 30px;border-radius:0 0 15px 15px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 5px 15px rgba(0,0,0,0.1);z-index:1000;backdrop-filter:blur(10px)}
        .navbar a{color:#34D399;text-decoration:none;margin:0 15px;font-weight:700}
        .container{max-width:1200px;margin:0 auto;background:#FFFFFF;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.15);padding:24px}
        .steps{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
        .step{flex:1;min-width:180px;background:#F9FAFB;border:2px solid #E5E7EB;border-radius:10px;padding:12px;text-align:center;color:#374151}
        .step.active{border-color:#34D399;background:#ECFDF5;color:#065F46;font-weight:700}
        .main{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .card{background:#FFFFFF;border:2px solid #E5E7EB;border-radius:12px;padding:16px}
        .btn{padding:14px 18px;border:none;border-radius:10px;font-weight:700;color:#FFFFFF;background:#34D399;cursor:pointer;transition:transform .2s ease}
        .btn:hover{transform:scale(1.03);box-shadow:0 8px 20px rgba(52,211,153,.35)}
        .btn-outline{background:transparent;color:#34D399;border:2px solid #34D399}
        .upload{border:2px dashed #D1D5DB;border-radius:12px;padding:24px;text-align:center;color:#6B7280;cursor:pointer}
        .list{margin-top:12px}
        .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid #E5E7EB;border-radius:10px;margin-bottom:8px}
        .item input{width:120px;padding:6px 8px;border:2px solid #E5E7EB;border-radius:8px}
        .status{margin-top:12px;color:#065F46;background:#ECFDF5;border:2px solid #A7F3D0;border-radius:10px;padding:10px;text-align:center}
        .footer{margin-top:16px;display:flex;justify-content:center}
    </style>
</head>
<body>
    <div class="navbar">
        <div>
            <a href="/">ğŸ  é¦–é¡µ</a>
            <a href="/library">ğŸ“š èœå“åº“</a>
            <a href="/recommend">ğŸ’¡ ä¸ªæ€§åŒ–æ¨è</a>
            <a href="/pickup">âš–ï¸ å–é¤è¯†åˆ«</a>
        </div>
        <div>
            <span style="color:#374151">æ¬¢è¿, {{ user.username }}</span>
            <a href="/logout">ğŸšª é€€å‡º</a>
        </div>
    </div>

    <div class="container">
        <div class="steps">
            <div class="step active">1. ç»‘å®šé¤ç›˜</div>
            <div class="step">2. å–é¤ç§°é‡</div>
            <div class="step">3. ä¸Šä¼ å›¾åƒ</div>
            <div class="step">4. è¥å…»åˆ†æ</div>
        </div>

        <div class="main">
            <div class="card">
                <h3 style="margin-bottom:10px;color:#111;font-weight:800">æ‰«ç ç»‘å®šé¤ç›˜</h3>
                <button class="btn" onclick="bindPlate()">ğŸ“· æ‰«æé¤ç›˜äºŒç»´ç </button>
                <div id="bindMsg" style="margin-top:10px;color:#6B7280;font-size:14px"></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:10px;color:#111;font-weight:800">ä¸Šä¼ é¤ç›˜å›¾åƒ</h3>
                <div class="upload" onclick="document.getElementById('imageInput').click()">ç‚¹å‡»æ‹ç…§ / ä¸Šä¼ é¤ç›˜å…¨æ™¯å›¾</div>
                <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImage(event)">
                <div id="preview" style="margin-top:10px"></div>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <h3 style="margin-bottom:10px;color:#111;font-weight:800">èœå“è®°å½•</h3>
            <div class="list" id="dishList"></div>
            <div class="status" id="statusBar" style="display:none"></div>
        </div>

        <div class="footer">
            <button class="btn" onclick="goAnalysis()" style="width:100%">å®Œæˆå–é¤ï¼Œå¼€å§‹è¥å…»åˆ†æ</button>
        </div>
    </div>

    <script>
        let lastResult = null;
        function bindPlate(){
            document.getElementById('bindMsg').textContent='å·²ç»‘å®šé¤ç›˜';
        }
        async function handleImage(e){
            const file = e.target.files[0];
            if(!file) return;
            const imgURL = URL.createObjectURL(file);
            document.getElementById('preview').innerHTML = `<img src="${imgURL}" style="max-width:100%; border-radius:10px">`;
            const form = new FormData();
            form.append('image', file);
            const res = await fetch('/detect', { method:'POST', body: form });
            const data = await res.json();
            lastResult = data;
            const list = document.getElementById('dishList');
            list.innerHTML = '';
            const detections = data.detections || [];
            const alignment = data.alignment || {};
            const aligned = alignment.aligned_foods || [];
            const byNameWeight = {};
            aligned.forEach(a=>{ byNameWeight[a.class] = a.weight });
            detections.forEach((det,i)=>{
                const w = byNameWeight[det.class];
                const weight = typeof w==='number'? `${w.toFixed(1)} g` : 'å¾…ç§°é‡';
                const row = document.createElement('div');
                row.className='item';
                row.innerHTML = `<div style="display:flex; align-items:center; gap:8px">
                    <strong>${det.class}</strong>
                    <span style="color:#6B7280; font-size:12px">#${i+1}</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px">
                    <input value="${weight}" id="w_${i}">
                    <button class="btn-outline" onclick="editWeight(${i})">ç¼–è¾‘</button>
                </div>`;
                list.appendChild(row);
            });
            const acc = detections.length>0 ? Math.min(98, 90 + Math.round(Math.random()*8)) : 0;
            document.getElementById('statusBar').style.display='block';
            document.getElementById('statusBar').textContent = `å·²è®°å½• ${detections.length} é“èœå“ | å·²è¯†åˆ«å‡†ç¡®ç‡ï¼š${acc}%`;
        }
        function editWeight(i){
            const input = document.getElementById('w_'+i);
            input.focus();
        }
        function goAnalysis(){
            if(!lastResult){ alert('è¯·å…ˆä¸Šä¼ å›¾åƒ'); return; }
            sessionStorage.setItem('last_detection', JSON.stringify(lastResult));
            window.location.href='/analysis';
        }
    </script>
</body>
</html>
