<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†è§‰-é‡é‡å¯¹é½æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        /* å“åº”å¼è®¾è®¡ - åª’ä½“æŸ¥è¯¢ */
        @media (max-width: 768px) {
            /* è°ƒæ•´æ•´ä½“å†…è¾¹è· */
            body {
                padding: 15px;
            }

            /* å®¹å™¨è°ƒæ•´ */
            .container {
                padding: 25px;
                border-radius: 15px;
            }

            /* æ ‡é¢˜å¤§å°è°ƒæ•´ */
            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            h2 {
                font-size: 1.5em;
            }

            h3 {
                font-size: 1.3em;
            }

            /* æŒ‰é’®ç»„è°ƒæ•´ */
            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            button {
                padding: 12px 25px;
                font-size: 14px;
                width: 100%;
                max-width: 300px;
            }

            .btn-success {
                font-size: 16px;
            }

            /* ç½‘æ ¼å¸ƒå±€è°ƒæ•´ */
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .metrics {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            /* å¯¹é½ç»“æœå¡ç‰‡è°ƒæ•´ */
            div[style*="grid-template-columns: repeat(3, 1fr)"] {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            /* ä¸Šä¼ åŒºåŸŸè°ƒæ•´ */
            .upload-area {
                padding: 20px 15px;
            }

            /* å¡ç‰‡å…ƒç´ è°ƒæ•´ */
            .section {
                padding: 15px;
                margin-bottom: 20px;
            }

            .weight-event {
                padding: 8px 10px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            /* è¿›ä¸€æ­¥ç¼©å°å±å¹•çš„è°ƒæ•´ */
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.3em;
            }

            h3 {
                font-size: 1.1em;
            }

            button {
                padding: 10px 20px;
                font-size: 13px;
                max-width: 250px;
            }

            .metrics {
                grid-template-columns: 1fr;
            }

            .metric-card {
                padding: 10px;
            }

            .metric-card .value {
                font-size: 24px;
            }

            /* ä¸Šä¼ åŒºåŸŸè°ƒæ•´ */
            .upload-area {
                padding: 15px 10px;
            }

            /* å¯¹é½ç»“æœå¡ç‰‡è°ƒæ•´ */
            .alignment-result {
                padding: 12px;
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .weight-simulator {
            margin-top: 20px;
        }

        .weight-events {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .weight-event {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
        }

        .results-container {
            margin-top: 20px;
        }

        .alignment-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }

        .matched {
            border-left-color: #4caf50;
        }

        .unmatched {
            border-left-color: #ff9800;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card h3 {
            color: #999;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .metric-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin: 20px 0;
        }

        input[type="file"] {
            display: none;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¯ è§†è§‰-é‡é‡å¯¹é½ç®—æ³•æ¼”ç¤º</h1>

        <div class="info-box">
            <h3>ğŸ“– ç®—æ³•è¯´æ˜</h3>
            <p>
                æœ¬ç®—æ³•èƒ½å¤Ÿå°†é¤ç›˜åº•éƒ¨é‡é‡ä¼ æ„Ÿå™¨è®°å½•çš„æ—¶åºé‡é‡æ•°æ®ä¸YOLOæ£€æµ‹åˆ°çš„èœå“è¿›è¡Œç²¾å‡†å¯¹é½ã€‚
                æ”¯æŒå¤„ç†æ•°é‡ä¸ä¸€è‡´ã€é¡ºåºé”™ä½ç­‰å¼‚å¸¸æƒ…å†µã€‚
            </p>
        </div>

        <!-- åœºæ™¯é€‰æ‹© -->
        <div class="section">
            <h2>1ï¸âƒ£ é€‰æ‹©æµ‹è¯•åœºæ™¯</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="loadScenario('normal')">
                    æ­£å¸¸åœºæ™¯ï¼ˆæ•°é‡ä¸€è‡´ï¼‰
                </button>
                <button class="btn-warning" onclick="loadScenario('missing')">
                    æ¼æ£€åœºæ™¯ï¼ˆä¼ æ„Ÿå™¨æ¼æ£€ï¼‰
                </button>
                <button class="btn-warning" onclick="loadScenario('extra')">
                    è¯¯æ£€åœºæ™¯ï¼ˆé¢å¤–é‡é‡ï¼‰
                </button>
                <button class="btn-warning" onclick="loadScenario('merged')">
                    åˆå¹¶åœºæ™¯ï¼ˆåŒæ—¶å–èœï¼‰
                </button>
            </div>

            <div id="scenarioInfo" style="margin-top: 15px; color: #666;"></div>
        </div>

        <!-- æ¨¡æ‹Ÿæ•°æ® -->
        <div class="section">
            <h2>2ï¸âƒ£ æ¨¡æ‹Ÿæ•°æ®</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: #555; margin-bottom: 10px;">ğŸ± æ£€æµ‹åˆ°çš„èœå“</h3>
                    <div id="detectedFoods" class="weight-events"></div>
                </div>

                <div>
                    <h3 style="color: #555; margin-bottom: 10px;">âš–ï¸ é‡é‡ä¼ æ„Ÿå™¨æ•°æ®</h3>
                    <div id="weightEvents" class="weight-events"></div>
                </div>
            </div>
        </div>

        <!-- æ‰§è¡Œå¯¹é½ -->
        <div class="section">
            <h2>3ï¸âƒ£ æ‰§è¡Œå¯¹é½</h2>
            <button class="btn-success" onclick="executeAlignment()" style="font-size: 18px;">
                ğŸš€ å¼€å§‹å¯¹é½ç®—æ³•
            </button>
        </div>

        <!-- å¯¹é½ç»“æœ -->
        <div class="section" id="resultsSection" style="display: none;">
            <h2>4ï¸âƒ£ å¯¹é½ç»“æœ</h2>

            <div class="metrics" id="metricsDisplay"></div>

            <div class="results-container" id="alignmentResults"></div>
        </div>

        <!-- ä¸Šä¼ çœŸå®å›¾ç‰‡æµ‹è¯• -->
        <div class="section">
            <h2>5ï¸âƒ£ ä¸Šä¼ çœŸå®å›¾ç‰‡æµ‹è¯•ï¼ˆå¯é€‰ï¼‰</h2>
            <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                <p>ğŸ“ ç‚¹å‡»ä¸Šä¼ é¤ç›˜å›¾ç‰‡</p>
                <p style="color: #999; font-size: 14px; margin-top: 10px;">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
            </div>
            <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">

            <div id="imagePreview"></div>
        </div>
    </div>

    <script>
        let currentScenario = 'normal';
        let simulatedData = null;

        // æ¨¡æ‹Ÿåœºæ™¯æ•°æ®
        const scenarios = {
            normal: {
                name: 'æ­£å¸¸åœºæ™¯',
                description: '4ä¸ªèœå“ï¼Œ4æ¬¡é‡é‡äº‹ä»¶ï¼Œä¸€ä¸€å¯¹åº”',
                foods: [
                    { name: 'çº¢çƒ§è‚‰', x: 150, y: 200, area: 10000, weight: 85 },
                    { name: 'é’èœ', x: 285, y: 220, area: 5600, weight: 45 },
                    { name: 'ç±³é¥­', x: 415, y: 220, area: 15600, weight: 120 },
                    { name: 'è±†è…', x: 540, y: 230, area: 6400, weight: 55 }
                ],
                weightMultiplier: 1
            },
            missing: {
                name: 'æ¼æ£€åœºæ™¯',
                description: '4ä¸ªèœå“ï¼Œä½†åªæœ‰3æ¬¡é‡é‡äº‹ä»¶ï¼ˆä¼ æ„Ÿå™¨æ¼æ£€ï¼‰',
                foods: [
                    { name: 'çº¢çƒ§è‚‰', x: 150, y: 200, area: 10000, weight: 85 },
                    { name: 'é’èœ', x: 285, y: 220, area: 5600, weight: 45 },
                    { name: 'ç±³é¥­', x: 415, y: 220, area: 15600, weight: 120 },
                    { name: 'è±†è…', x: 540, y: 230, area: 6400, weight: 55 }
                ],
                skipWeightIndex: 1  // è·³è¿‡ç¬¬2ä¸ªé‡é‡äº‹ä»¶
            },
            extra: {
                name: 'è¯¯æ£€åœºæ™¯',
                description: '4ä¸ªèœå“ï¼Œä½†æœ‰5æ¬¡é‡é‡äº‹ä»¶ï¼ˆé¢å¤–å™ªå£°ï¼‰',
                foods: [
                    { name: 'çº¢çƒ§è‚‰', x: 150, y: 200, area: 10000, weight: 85 },
                    { name: 'é’èœ', x: 285, y: 220, area: 5600, weight: 45 },
                    { name: 'ç±³é¥­', x: 415, y: 220, area: 15600, weight: 120 },
                    { name: 'è±†è…', x: 540, y: 230, area: 6400, weight: 55 }
                ],
                extraWeight: { index: 2, weight: 25 }  // åœ¨ç¬¬3ä¸ªä½ç½®æ’å…¥é¢å¤–é‡é‡
            },
            merged: {
                name: 'åˆå¹¶åœºæ™¯',
                description: '4ä¸ªèœå“ï¼Œä½†åªæœ‰3æ¬¡é‡é‡äº‹ä»¶ï¼ˆåŒæ—¶å–äº†2ä¸ªèœï¼‰',
                foods: [
                    { name: 'çº¢çƒ§è‚‰', x: 150, y: 200, area: 10000, weight: 85 },
                    { name: 'é’èœ', x: 285, y: 220, area: 5600, weight: 45 },
                    { name: 'ç±³é¥­', x: 415, y: 220, area: 15600, weight: 120 },
                    { name: 'è±†è…', x: 540, y: 230, area: 6400, weight: 55 }
                ],
                mergeIndices: [1, 2]  // åˆå¹¶ç¬¬2å’Œç¬¬3ä¸ªé‡é‡
            }
        };

        function loadScenario(scenarioType) {
            currentScenario = scenarioType;
            const scenario = scenarios[scenarioType];

            document.getElementById('scenarioInfo').innerHTML = `
                <strong>${scenario.name}</strong>: ${scenario.description}
            `;

            // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„èœå“
            let foodsHTML = '';
            scenario.foods.forEach((food, i) => {
                foodsHTML += `
                    <div class="weight-event">
                        <strong>èœå“ ${i + 1}</strong>: ${food.name} 
                        (ä½ç½®: ${food.x}, ${food.y}, é¢ç§¯: ${food.area}pxÂ²)
                    </div>
                `;
            });
            document.getElementById('detectedFoods').innerHTML = foodsHTML;

            // ç”Ÿæˆé‡é‡äº‹ä»¶
            const weights = generateWeightEvents(scenario);
            let weightsHTML = '<div class="weight-event"><strong>åˆå§‹</strong>: 0.00g (ç´¯è®¡: 0.00g)</div>';
            let cumulative = 0;

            weights.forEach((w, i) => {
                cumulative += w;
                weightsHTML += `
                    <div class="weight-event">
                        <strong>äº‹ä»¶ ${i + 1}</strong>: +${w.toFixed(2)}g (ç´¯è®¡: ${cumulative.toFixed(2)}g)
                    </div>
                `;
            });
            document.getElementById('weightEvents').innerHTML = weightsHTML;

            // ä¿å­˜æ¨¡æ‹Ÿæ•°æ®
            simulatedData = {
                foods: scenario.foods,
                weights: weights,
                scenario: scenarioType
            };

            // éšè—ç»“æœ
            document.getElementById('resultsSection').style.display = 'none';
        }

        function generateWeightEvents(scenario) {
            const weights = scenario.foods.map(f => f.weight + (Math.random() - 0.5) * 2);

            if (scenario.skipWeightIndex !== undefined) {
                // æ¼æ£€ï¼šç§»é™¤æŸä¸ªé‡é‡
                weights.splice(scenario.skipWeightIndex, 1);
            } else if (scenario.extraWeight) {
                // è¯¯æ£€ï¼šæ’å…¥é¢å¤–é‡é‡
                weights.splice(scenario.extraWeight.index, 0, scenario.extraWeight.weight);
            } else if (scenario.mergeIndices) {
                // åˆå¹¶ï¼šåˆå¹¶ä¸¤ä¸ªé‡é‡
                const [idx1, idx2] = scenario.mergeIndices;
                weights[idx1] = weights[idx1] + weights[idx2];
                weights.splice(idx2, 1);
            }

            return weights;
        }

        async function executeAlignment() {
            if (!simulatedData) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæµ‹è¯•åœºæ™¯');
                return;
            }

            // æ„å»ºè¯·æ±‚æ•°æ®
            const detections = simulatedData.foods.map(food => ({
                class: food.name,
                confidence: 0.95,
                bbox: [
                    food.x - Math.sqrt(food.area) / 2,
                    food.y - Math.sqrt(food.area) / 2,
                    food.x + Math.sqrt(food.area) / 2,
                    food.y + Math.sqrt(food.area) / 2
                ]
            }));

            // æ„å»ºé‡é‡äº‹ä»¶
            const weightEvents = [{ timestamp: 0, cumulative_weight: 0, delta_weight: 0 }];
            let cumulative = 0;
            let timestamp = 0;

            simulatedData.weights.forEach((w, i) => {
                timestamp += 1.0 + Math.random();
                cumulative += w;
                weightEvents.push({
                    timestamp: timestamp,
                    cumulative_weight: cumulative,
                    delta_weight: w
                });
            });

            // è°ƒç”¨åç«¯APIï¼ˆè¿™é‡Œç›´æ¥åœ¨å‰ç«¯æ¨¡æ‹Ÿï¼‰
            // å®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨ /detect æ¥å£
            const result = simulateAlignment(detections, weightEvents);

            displayResults(result);
        }

        function simulateAlignment(detections, weightEvents) {
            // ç®€åŒ–çš„å‰ç«¯æ¨¡æ‹Ÿï¼ˆå®é™…åº”ä½¿ç”¨åç«¯ç®—æ³•ï¼‰
            const foods = detections.map((det, i) => ({
                class: det.class,
                bbox: det.bbox,
                center_x: (det.bbox[0] + det.bbox[2]) / 2,
                weight: 0,
                matched: false
            }));

            const weights = weightEvents.slice(1).map(e => e.delta_weight);

            // æŒ‰ä½ç½®æ’åº
            foods.sort((a, b) => a.center_x - b.center_x);

            // ç®€å•åŒ¹é…
            const aligned = foods.map((food, i) => {
                if (i < weights.length) {
                    return {
                        ...food,
                        weight: weights[i],
                        matched: true,
                        confidence: 0.85
                    };
                } else {
                    return {
                        ...food,
                        weight: food.bbox ? (food.bbox[2] - food.bbox[0]) * 0.1 : 50,
                        matched: false,
                        confidence: 0.3
                    };
                }
            });

            return {
                aligned_foods: aligned,
                metrics: {
                    total_foods: foods.length,
                    matched_foods: aligned.filter(a => a.matched).length,
                    unmatched_foods: aligned.filter(a => !a.matched).length,
                    avg_confidence: aligned.reduce((sum, a) => sum + a.confidence, 0) / aligned.length,
                    total_weight: aligned.reduce((sum, a) => sum + a.weight, 0)
                }
            };
        }

        function displayResults(result) {
            document.getElementById('resultsSection').style.display = 'block';

            // æ˜¾ç¤ºæŒ‡æ ‡
            const metrics = result.metrics;
            document.getElementById('metricsDisplay').innerHTML = `
                <div class="metric-card">
                    <h3>æ€»èœå“æ•°</h3>
                    <div class="value">${metrics.total_foods}</div>
                </div>
                <div class="metric-card">
                    <h3>æˆåŠŸåŒ¹é…</h3>
                    <div class="value">${metrics.matched_foods}</div>
                </div>
                <div class="metric-card">
                    <h3>æœªåŒ¹é…</h3>
                    <div class="value">${metrics.unmatched_foods}</div>
                </div>
                <div class="metric-card">
                    <h3>å¹³å‡ç½®ä¿¡åº¦</h3>
                    <div class="value">${(metrics.avg_confidence * 100).toFixed(1)}%</div>
                </div>
                <div class="metric-card">
                    <h3>æ€»é‡é‡</h3>
                    <div class="value">${metrics.total_weight.toFixed(1)}g</div>
                </div>
            `;

            // æ˜¾ç¤ºå¯¹é½ç»“æœ
            let resultsHTML = '';
            result.aligned_foods.forEach((food, i) => {
                const statusClass = food.matched ? 'matched' : 'unmatched';
                const statusText = food.matched ? 'âœ… å·²åŒ¹é…' : 'âš ï¸ æœªåŒ¹é…ï¼ˆä½¿ç”¨ä¼°è®¡å€¼ï¼‰';

                resultsHTML += `
                    <div class="alignment-result ${statusClass}">
                        <h3 style="margin-bottom: 10px;">èœå“ #${i + 1}: ${food.class}</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div>
                                <strong>é‡é‡:</strong> ${food.weight.toFixed(2)}g
                            </div>
                            <div>
                                <strong>çŠ¶æ€:</strong> ${statusText}
                            </div>
                            <div>
                                <strong>ç½®ä¿¡åº¦:</strong> ${(food.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('alignmentResults').innerHTML = resultsHTML;

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imagePreview').innerHTML = `
                    <h3 style="margin: 20px 0 10px 0;">ä¸Šä¼ çš„å›¾ç‰‡:</h3>
                    <img src="${e.target.result}" class="preview-image" alt="ä¸Šä¼ çš„å›¾ç‰‡">
                    <p style="color: #666; margin-top: 10px;">
                        æç¤º: å®é™…ä½¿ç”¨æ—¶ä¼šè°ƒç”¨YOLOæ¨¡å‹è¿›è¡Œæ£€æµ‹ï¼Œå¹¶æ‰§è¡Œè§†è§‰-é‡é‡å¯¹é½ç®—æ³•
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        // é¡µé¢åŠ è½½æ—¶é»˜è®¤æ˜¾ç¤ºæ­£å¸¸åœºæ™¯
        window.onload = function () {
            loadScenario('normal');
        };
    </script>
</body>

</html>